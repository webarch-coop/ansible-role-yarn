---
- name: apt-transport-https package present
  apt:
    pkg:
      - apt-transport-https
      - curl
    state: present
    update_cache: false
  tags:
    - yarn

- name: Yarn GPG key present
  apt_key:
    id: 1646B01B86E50310
    url: https://dl.yarnpkg.com/debian/pubkey.gpg
    state: present
  tags:
    - yarn

- name: Yarn APT repo available
  apt_repository:
    filename: yarn
    repo: "deb https://dl.yarnpkg.com/debian/ stable main"
    state: present
  tags:
    - yarn

- name: Install Yarn and update GPG key if this fails 
  block:

    - name: Yarn package present
      apt:
        pkg:
          - yarn
        state: present
        update_cache: true

  rescue:

    - name: Manually update GPG key
      shell: curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -

    - name: Yarn package present
      apt:
        pkg:
          - yarn
        state: present
        update_cache: true

  tags:
    - yarn
...
